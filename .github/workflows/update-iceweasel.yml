name: ðŸ”„ Weekly Iceweasel Version Update

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 02:00 UTC
  workflow_dispatch:      # Allow manual trigger

permissions:
  contents: write         # Required to push changes

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Get latest Iceweasel release tag
        id: get_tag
        run: |
          # Get the effective URL after redirect from /releases/latest
          latest_url=$(curl -fsSL -o /dev/null -w '%{url_effective}' -L "https://github.com/adonais/iceweasel/releases/latest")
          # Extract tag (e.g., v147.0.0)
          tag=$(echo "$latest_url" | grep -oP '/tag/\K[^/?#]+')
          if [[ -z "$tag" ]]; then
            echo "ERROR: Failed to extract tag from URL: $latest_url"
            exit 1
          fi
          echo "Latest tag: $tag"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: ðŸ“„ Read current version from manifest
        id: read_current
        run: |
          file="bucket/iceweasel.json"
          if [[ ! -f "$file" ]]; then
            echo "ERROR: Manifest not found: $file"
            exit 1
          fi
          current=$(jq -r '.version' "$file")
          if [[ -z "$current" ]]; then
            echo "ERROR: Failed to read 'version' from manifest"
            exit 1
          fi
          echo "Current version: $current"
          echo "current=$current" >> $GITHUB_OUTPUT

      - name: ðŸ”„ Replace all occurrences of old version with new version
        id: replace
        if: steps.get_tag.outputs.tag != steps.read_current.outputs.current
        run: |
          file="bucket/iceweasel.json"
          old="${{ steps.read_current.outputs.current }}"
          new="${{ steps.get_tag.outputs.tag }}"
          echo "Replacing all occurrences of '$old' with '$new' in $file"

          # Use sed to replace literal string (escape special regex chars)
          escaped_old=$(printf '%s\n' "$old" | sed 's/[[\.*^$()+?{|]/\\&/g')
          sed -i "s/$escaped_old/$new/g" "$file"

          # Ensure file ends with newline (required by Scoop tests)
          if [[ -n $(tail -c1 "$file" | od -An -tx1) ]]; then
            echo >> "$file"
          fi

          echo "updated=true" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Commit and push if updated
        if: steps.replace.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/iceweasel.json
          git commit -m "chore(iceweasel): update to ${{ steps.get_tag.outputs.tag }}"
          git push
          echo "âœ… Successfully updated and pushed new version!"
