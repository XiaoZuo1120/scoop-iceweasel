name: ðŸ”„ Update Iceweasel Version

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€ 02:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Get latest GitHub release tag
        id: get_tag
        run: |
          url=$(curl -fsSL -o /dev/null -w '%{url_effective}' -L "https://github.com/adonais/iceweasel/releases/latest")
          tag=$(echo "$url" | grep -oP '/tag/\K[^/?#]+')
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: ðŸ“„ Read current version
        id: current
        run: |
          ver=$(jq -r '.version' bucket/iceweasel.json)
          echo "current=$ver" >> $GITHUB_OUTPUT

      - name: ðŸ”„ Update version if changed
        if: steps.get_tag.outputs.tag != steps.current.outputs.current
        run: |
          jq --arg v "${{ steps.get_tag.outputs.tag }}" '.version = $v' bucket/iceweasel.json > tmp.json
          mv tmp.json bucket/iceweasel.json

      - name: ðŸ’¾ Commit and push
        if: steps.get_tag.outputs.tag != steps.current.outputs.current
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/iceweasel.json
          git commit -m "chore: update Iceweasel to ${{ steps.get_tag.outputs.tag }}"
          git push